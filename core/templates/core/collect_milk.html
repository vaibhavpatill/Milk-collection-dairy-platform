{% extends 'base.html' %}
{% block content %}
{% if messages %}
<script>
{% for message in messages %}
  {% if message.tags == 'error' %}
    alert('{{ message }}');
  {% endif %}
{% endfor %}
</script>
{% endif %}
<style>
  .collection-table {
    background: #f9fbe7;
    border-radius: 16px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.10);
    padding: 32px;
    max-width: 800px;
    margin: 0 auto;
  }
  .collection-table th {
    background: #e0f2f1;
    font-weight: 600;
    text-align: left;
    padding: 10px;
    font-size: 1.1rem;
  }
  .collection-table td {
    padding: 10px;
    vertical-align: middle;
    font-size: 1.1rem;
  }
  .form-btn {
    width: 100%;
    font-size: 1.15rem;
    margin-top: 18px;
    font-weight: 600;
    letter-spacing: 1px;
  }
  .icon {
    font-size: 1.3rem;
    margin-right: 8px;
  }
  .hero {
    background: linear-gradient(90deg, #e0f7fa 0%, #fffde4 100%);
    border-radius: 16px;
    padding: 24px 0 16px 0;
    margin-bottom: 24px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
  }
</style>
<div class="hero">
  <img src="https://milkcollectionsystem.in/images/hero-infograph-edit.svg" alt="Milk Collection" style="height:60px; margin-bottom:10px;">
  <h2 class="mb-2">Milk Collection Dairy PWA</h2>
  <p style="font-size:1.1rem; color:#00796b;">Automate milk collection, manage rates, and view history with a simple, attractive interface.</p>
</div>
<form method="post" class="collection-table mb-4">
    {% csrf_token %}
    <table class="table mb-0">
      <tbody>
        <tr>
          <th colspan="2">
            <span class="icon">â°</span>
            <label><input type="radio" name="session" value="morning" checked onclick="toggleSession('morning')"> Morning</label>
            <label class="ms-3"><input type="radio" name="session" value="evening" onclick="toggleSession('evening')"> Evening</label>
          </th>
        </tr>
        <tr>
          <th><span class="icon">ğŸ„</span>Producer</th>
          <td>
            <div class="d-flex gap-2">
              <select name="producer" class="form-control" onchange="loadProducerHistory()">
                <option value="">Select Producer</option>
                {% for producer in form.producer.field.queryset %}
                <option value="{{ producer.id }}" {% if selected_producer.id == producer.id %}selected{% endif %}>{{ producer.full_name }}</option>
                {% endfor %}
              </select>
              <button type="button" class="btn btn-success btn-sm" onclick="showRegisterForm()" title="Register New Producer">
                <span class="icon">â•</span>New
              </button>
            </div>
          </td>
        </tr>
        <tr>
          <th><span class="icon">ğŸ“…</span>Date</th>
          <td>{{ form.date }}</td>
        </tr>
        <tr>
          <th><span class="icon">ğŸ¥›</span>Milk Type</th>
          <td><select name="milk_type" class="form-control" onchange="updateRate()">
            <option value="cow">Cow</option>
            <option value="buffalo">Buffalo</option>
          </select></td>
        </tr>
        <tr class="morning-row">
          <th><span class="icon">ğŸŒ…</span>Morning Litres</th>
          <td><input type="number" step="0.01" name="morning_litres" class="form-control" placeholder="Morning litres" onchange="updateRate()"></td>
        </tr>
        <tr class="morning-row">
          <th><span class="icon">ğŸ’§</span>Morning Fat Value</th>
          <td><input type="number" step="0.01" name="morning_fat" class="form-control" placeholder="Fat value for morning" onchange="updateRate()"></td>
        </tr>
        <tr class="morning-row">
          <th><span class="icon">ğŸ§ª</span>Morning SNF</th>
          <td><input type="number" step="0.01" name="morning_snf" class="form-control" placeholder="SNF for morning"></td>
        </tr>
        <tr class="evening-row" style="display:none;">
          <th><span class="icon">ğŸŒ‡</span>Evening Litres</th>
          <td><input type="number" step="0.01" name="evening_litres" class="form-control" placeholder="Evening litres" onchange="updateRate()"></td>
        </tr>
        <tr class="evening-row" style="display:none;">
          <th><span class="icon">ğŸ’§</span>Evening Fat Value</th>
          <td><input type="number" step="0.01" name="evening_fat" class="form-control" placeholder="Fat value for evening" onchange="updateRate()"></td>
        </tr>
        <tr class="evening-row" style="display:none;">
          <th><span class="icon">ğŸ§ª</span>Evening SNF</th>
          <td><input type="number" step="0.01" name="evening_snf" class="form-control" placeholder="SNF for evening"></td>
        </tr>
      </tbody>
    </table>
    <div id="rate-display" class="alert alert-info mt-3 text-center" style="display:none;"></div>
    <button type="submit" class="btn btn-success form-btn"><span class="icon">âœ…</span>Submit Collection</button>
</form>
<script>
function toggleSession(session) {
  if(session === 'morning') {
    document.querySelectorAll('.morning-row').forEach(e => e.style.display = '');
    document.querySelectorAll('.evening-row').forEach(e => e.style.display = 'none');
  } else {
    document.querySelectorAll('.morning-row').forEach(e => e.style.display = 'none');
    document.querySelectorAll('.evening-row').forEach(e => e.style.display = '');
  }
  updateRate();
}

function loadProducerHistory() {
  const producerId = document.querySelector('select[name="producer"]').value;
  if (producerId) {
    window.location.href = `?producer=${producerId}`;
  } else {
    window.location.href = window.location.pathname;
  }
}

function updateRate() {
  const session = document.querySelector('input[name="session"]:checked').value;
  const milkType = document.querySelector('select[name="milk_type"]').value;
  const fatValue = session === 'morning' ? 
    document.querySelector('input[name="morning_fat"]').value : 
    document.querySelector('input[name="evening_fat"]').value;
  const litres = session === 'morning' ? 
    document.querySelector('input[name="morning_litres"]').value : 
    document.querySelector('input[name="evening_litres"]').value;
  
  if (fatValue && milkType) {
    fetch('/get_rate/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({
        milk_type: milkType,
        fat_value: parseFloat(fatValue)
      })
    })
    .then(response => response.json())
    .then(data => {
      const rate = data.rate || 30;
      const total = (parseFloat(litres) || 0) * rate;
      const rateDiv = document.getElementById('rate-display');
      rateDiv.innerHTML = `<strong>Rate:</strong> â‚¹${rate} per litre<br><strong>Total Amount:</strong> â‚¹${total.toFixed(2)}`;
      rateDiv.style.display = 'block';
    })
    .catch(error => console.error('Error:', error));
  }
}
</script>
{% if rate is not None %}
    <div class="alert alert-info mt-3 text-center">
        <strong>Rate:</strong> â‚¹{{ rate }} per litre<br>
        <strong>Total Amount:</strong> â‚¹{{ total_amount }}
    </div>
{% endif %}
{% if selected_producer and ten_days_summary %}
<div class="d-flex justify-content-between align-items-center mt-5 mb-3">
  <h3 class="mb-0">10-Day Billing Period {{ current_period }} - {{ selected_producer.full_name }}</h3>
  <div class="btn-group">
    {% if has_previous %}
      <a href="?producer={{ selected_producer.id }}&period={{ current_period }}" class="btn btn-outline-primary btn-sm">â† Previous 10 Days</a>
    {% endif %}
    {% if has_next %}
      <a href="?producer={{ selected_producer.id }}&period={{ current_period|add:'-2' }}" class="btn btn-outline-primary btn-sm">Next 10 Days â†’</a>
    {% endif %}
    {% if current_period > 1 %}
      <a href="?producer={{ selected_producer.id }}&period=0" class="btn btn-primary btn-sm">Current Period</a>
    {% endif %}
  </div>
</div>
<div class="table-responsive">
  <table class="table table-bordered table-striped">
    <thead style="background:#e0f2f1;">
      <tr>
        <th>Date</th>
        <th>Status</th>
        <th>Morning L</th>
        <th>Evening L</th>
        <th>Total L</th>
        <th>Fat %</th>
        <th>Rate</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody>
      {% for day in ten_days_summary %}
      <tr {% if not day.has_collection %}style="background-color: #ffebee;"{% endif %}>
        <td>{{ day.date }}</td>
        <td>
          {% if day.has_collection %}
            <span class="badge bg-success">âœ“ Collected</span>
          {% else %}
            <span class="badge bg-danger">âœ— No Collection</span>
          {% endif %}
        </td>
        <td>{{ day.morning_litres|floatformat:2 }}</td>
        <td>{{ day.evening_litres|floatformat:2 }}</td>
        <td>{{ day.total_litres|floatformat:2 }}</td>
        <td>{{ day.fat_value|floatformat:1 }}</td>
        <td>â‚¹{{ day.rate|floatformat:0 }}</td>
        <td>â‚¹{{ day.amount|floatformat:2 }}</td>
      </tr>
      {% endfor %}
    </tbody>
    <tfoot style="background:#e8f5e8; font-weight:bold;">
      <tr>
        <td colspan="7">Period {{ current_period }} Total</td>
        <td>â‚¹{{ billing_total|floatformat:2 }}</td>
      </tr>
      {% if current_period == 1 %}
      <tr style="background:#fff3e0;">
        <td colspan="7">Less: Total Advance Money</td>
        <td>-â‚¹{{ total_advance|floatformat:2 }}</td>
      </tr>
      <tr style="background:#fff3e0;">
        <td colspan="7">Less: Total Feed Money</td>
        <td>-â‚¹{{ total_feed|floatformat:2 }}</td>
      </tr>
      <tr style="background:#c8e6c9; font-size:1.1rem;">
        <td colspan="7"><strong>Net Payable Amount</strong></td>
        <td><strong>â‚¹{{ net_payable|floatformat:2 }}</strong></td>
      </tr>
      {% else %}
      <tr style="background:#e3f2fd;">
        <td colspan="8"><em>Note: Deductions are only shown for the current billing period</em></td>
      </tr>
      {% endif %}
    </tfoot>
  </table>
</div>

<!-- Quick Deduction from Bill - Only show for current period -->
{% if current_period == 1 %}
<div class="mt-4">
  <div class="card">
    <div class="card-header bg-warning text-dark">
      <h5 class="mb-0">ğŸ’° Quick Deduction from Current Bill - {{ selected_producer.full_name }}</h5>
    </div>
    <div class="card-body">
      <form method="post" action="/milk/deductions/{{ selected_producer.id }}/">
        {% csrf_token %}
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">ğŸ“… Date</label>
            <input type="date" name="transaction_date" class="form-control" value="{{ today|date:'Y-m-d' }}" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">ğŸ’° Advance Amount (â‚¹)</label>
            <input type="number" step="0.01" name="advance_money" class="form-control" placeholder="0.00">
          </div>
          <div class="col-md-4">
            <label class="form-label">ğŸŒ¾ Feed Amount (â‚¹)</label>
            <input type="number" step="0.01" name="feed_money" class="form-control" placeholder="0.00">
          </div>
          <div class="col-md-6">
            <label class="form-label">ğŸ“ Advance Notes</label>
            <input type="text" name="advance_notes" class="form-control" placeholder="Purpose of advance">
          </div>
          <div class="col-md-6">
            <label class="form-label">ğŸ“ Feed Notes</label>
            <input type="text" name="feed_notes" class="form-control" placeholder="Feed details">
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-warning btn-lg">ğŸ’¾ Deduct from Bill</button>
            <a href="/manage/deductions/?producer={{ selected_producer.id }}" class="btn btn-info btn-sm ms-2">ğŸ“Š View All Deductions</a>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}
{% endif %}

<!-- Modal for New Producer Registration -->
<div class="modal fade" id="registerModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ğŸ‘¤ Register New Producer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="registerForm" onsubmit="registerProducer(event)">
        <div class="modal-body">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Full Name</label>
            <input type="text" name="full_name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Producer ID</label>
            <input type="text" name="producer_id" class="form-control" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Register Producer</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
function showRegisterForm() {
  const modal = new bootstrap.Modal(document.getElementById('registerModal'));
  modal.show();
}

function registerProducer(event) {
  event.preventDefault();
  const formData = new FormData(event.target);
  
  fetch('/producer/register/', {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    }
  })
  .then(response => {
    if (response.ok) {
      alert('Producer registered successfully!');
      location.reload(); // Refresh to show new producer in dropdown
    } else {
      alert('Error registering producer. Please try again.');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error registering producer. Please try again.');
  });
}
</script>

{% endblock %}

